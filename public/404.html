<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Halfway App Redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, #1e1e1e, #050505);
        color: #f5f5f5;
        padding: 24px;
      }
      .card {
        width: min(520px, 100%);
        background: rgba(12, 12, 12, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 40px 80px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(18px);
      }
      h1 {
        margin-top: 0;
        font-size: 1.75rem;
      }
      p {
        line-height: 1.5;
      }
      .links {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 24px;
      }
      a.button {
        padding: 12px 18px;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
        text-align: center;
        flex: 1 1 200px;
      }
      a.primary {
        background: #f97316;
        color: #050505;
      }
      a.secondary {
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: inherit;
      }
      .notice {
        margin-top: 16px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
      }
    </style>
  </head>
  <body>
    <main class="card" id="content">
      <h1 id="page-title">Page Not Found</h1>
      <p id="summary">We couldn't find the page you were looking for.</p>
      <p id="details">Double-check the URL or head back to the homepage.</p>
      <div class="links" id="link-wrapper" hidden>
        <a class="button primary" id="open-app-link" href="#">Open in the app</a>
        <a class="button secondary" id="app-store-link" href="https://apps.apple.com/bh/app/halfway-app/id6744035312"
          >Install from the App Store</a
        >
      </div>
      <p class="notice" id="status-message"></p>
    </main>
    <script>
      (function () {
        const APP_STORE_URL = "https://apps.apple.com/bh/app/halfway-app/id6744035312";
        const APP_ID = "6744035312";
        const PATH_CONFIG = {
          invite: {
            title: "Halfway Invite",
            label: "Invite ID",
            description: "Trying to open the app… If nothing happens, you will be redirected to the App Store.",
            scheme: (id) => `halfway://invite/${id}`,
          },
          place: {
            title: "View Location",
            label: "Place ID",
            description: "Trying to open the app… If nothing happens, you will be redirected to the App Store.",
            scheme: (id) => `halfway://place/${id}`,
          },
          profile: {
            title: "View Profile",
            label: "Profile ID",
            description: "Trying to open the app… If nothing happens, you will be redirected to the App Store.",
            scheme: (id) => `halfway://profile/${id}`,
          },
        };

        const titleEl = document.getElementById("page-title");
        const summaryEl = document.getElementById("summary");
        const detailsEl = document.getElementById("details");
        const linksEl = document.getElementById("link-wrapper");
        const openLinkEl = document.getElementById("open-app-link");
        const storeLinkEl = document.getElementById("app-store-link");
        const statusEl = document.getElementById("status-message");

        const normalizedPath = window.location.pathname.replace(/\/+$/, "") || "/";
        const match = normalizedPath.match(/^\/(invite|place|profile)(?:\/([^/?#]+))?$/i);

        if (!match) {
          return;
        }

        const route = match[1].toLowerCase();
        const identifier = match[2] ? decodeURIComponent(match[2]) : "";
        const config = PATH_CONFIG[route];

        if (!config) {
          return;
        }

        document.title = `${config.title} · Halfway`;

        if (!identifier) {
          titleEl.textContent = config.title;
          summaryEl.innerHTML = `${config.label}: <strong>Missing</strong>`;
          detailsEl.textContent =
            "Add the unique identifier to the URL to open the correct view (e.g. /invite/abc123).";
          return;
        }

        summaryEl.innerHTML = `${config.label}: <strong>${escapeHtml(identifier)}</strong>`;
        detailsEl.textContent = config.description;
        titleEl.textContent = config.title;
        linksEl.hidden = false;

        const appScheme = config.scheme(encodeURIComponent(identifier));
        openLinkEl.href = appScheme;
        storeLinkEl.href = APP_STORE_URL;
        statusEl.textContent = "Trying to open the app…";

        const universalUrl = `${window.location.origin}${normalizedPath}${window.location.search}${window.location.hash}`;
        injectItunesMeta(universalUrl);

        const openTimer = window.setTimeout(() => {
          if (document.visibilityState === "visible") {
            statusEl.textContent = "Opening the App Store…";
            window.location.replace(APP_STORE_URL);
          }
        }, 1200);

        const onVisibilityChange = () => {
          if (document.visibilityState === "hidden") {
            clearTimeout(openTimer);
          }
        };

        document.addEventListener("visibilitychange", onVisibilityChange, { once: false });

        const kickTimer = window.setTimeout(() => {
          window.location.href = appScheme;
        }, 0);

        window.addEventListener("pagehide", cleanup, { once: true });
        window.addEventListener("beforeunload", cleanup, { once: true });

        function cleanup() {
          clearTimeout(openTimer);
          clearTimeout(kickTimer);
          document.removeEventListener("visibilitychange", onVisibilityChange);
        }

        function escapeHtml(value) {
          return value.replace(/[&<>"']/g, (char) => {
            const chars = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            };
            return chars[char] || char;
          });
        }

        function injectItunesMeta(argumentUrl) {
          const meta = document.createElement("meta");
          meta.name = "apple-itunes-app";
          meta.content = `app-id=${APP_ID}, app-argument=${argumentUrl}`;
          document.head.appendChild(meta);
        }
      })();
    </script>
  </body>
</html>
